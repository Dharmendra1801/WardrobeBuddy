<!DOCTYPE html>
<html>
<head>
    <title>Products</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<button onclick="goBack()">Back</button>
<button onclick="logout()">Logout</button>

<!-- DELETE WARDROBE -->
<button style="background:red;color:white"
        onclick="deleteWardrobe()"> Delete Wardrobe
</button>

<h2 id="title"></h2>

<hr>

<!-- ADD PRODUCT -->
<h3>Add Product</h3>

<input id="pname" placeholder="Product name" required>
<input id="category" placeholder="Category">
<input id="brand" placeholder="Brand">
<input id="price" type="number" placeholder="Price">
<input id="quantity" type="number" placeholder="Quantity">
<textarea id="note" placeholder="Note"></textarea>

<button onclick="addProduct()">Add Product</button>

<hr>

<!-- FILTER BY CATEGORY -->
<h3>Filter by Category</h3>
<input id="searchCategory" placeholder="Enter category">
<button onclick="filterCategory()">Search</button>
<button onclick="loadProducts()">Show All</button>

<hr>

<!-- PRODUCT LIST -->
<div class="products" id="products"></div>

<script src="/js/auth.js"></script>

<script>
    const username = getUser();
    const params = new URLSearchParams(window.location.search);
    const wardrobe = params.get("wardrobe");

    document.getElementById("title").innerText =
      "Products in " + wardrobe;

    let allProducts = [];   // store all fetched products

    async function loadProducts() {
      const res = await fetch(
        `/api/${username}/${wardrobe}/product/all`
      );
      const list = await res.json();

      allProducts = list;  // store globally

      renderProducts(allProducts);
    }

    function renderProducts(list) {
      const container = document.getElementById("products");
      container.innerHTML = "";

      list.forEach(p => {
        const div = document.createElement("div");
        div.className = "product";

        div.onclick = () =>
          window.location.href =
            `/product-detail.html?id=${p.id}&wardrobe=${wardrobe}`;

        const img = document.createElement("img");
        img.src = p.image
          ? "data:image/jpeg;base64," + p.image
          : "https://via.placeholder.com/300";

        div.innerHTML = `
          <h3>${p.productName}</h3>
          <p>${p.category}</p>
          <p>${p.price}</p>
        `;

        div.prepend(img);
        container.appendChild(div);
      });
    }

    function filterCategory() {
      const category = document
        .getElementById("searchCategory")
        .value
        .toLowerCase()
        .trim();

      if (!category) {
        alert("Enter category");
        return;
      }

      const filtered = allProducts.filter(p =>
        p.category &&
        p.category.toLowerCase() === category
      );

      renderProducts(filtered);
    }

    async function addProduct() {
      const product = {
        productName: pname.value,
        category: category.value,
        brand: brand.value,
        price: price.value,
        quantity: quantity.value,
        note: note.value
      };

      const res = await fetch(
        `/api/${username}/${wardrobe}/product/add`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(product)
        }
      );

      if (res.ok) {
        alert("Product added");
        loadProducts();
      } else {
        alert(await res.text());
      }
    }

    async function deleteWardrobe() {
      if (!confirm("Delete this wardrobe?")) return;

      const res = await fetch(
        `/api/${username}/wardrobe/delete/${wardrobe}`,
        { method: "DELETE" }
      );

      if (res.ok) {
        alert("Wardrobe deleted");
        window.location.href = "/wardrobes.html";
      } else {
        alert(await res.text());
      }
    }

    function goBack() {
      window.history.back();
    }

    loadProducts();
</script>

</body>
</html>
